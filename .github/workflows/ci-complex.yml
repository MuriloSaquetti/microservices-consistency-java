
name: CI/CD – Microservices Consistency Java

on:
  push:
    branches: [ "main", "develop", "feature/**" ]
  pull_request:
    branches: [ "main", "develop" ]
  workflow_dispatch:
    inputs:
      release:
        description: "Publicar imagem e artefatos?"
        type: boolean
        default: false
  schedule:
    - cron: '0 2 * * *'  # Build noturno

permissions:
  contents: read
  packages: write
  security-events: write

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

env:
  JAVA_DISTRIBUTION: temurin
  SERVICE_NAME: microservices-consistency-java
  DOCKER_IMAGE: ghcr.io/${{ github.repository }}/microservices-consistency-java

jobs:
  validate:
    name: Validar | Lint + Unit
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        java: [ '17', '21' ]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configurar Java ${{ matrix.java }}
        uses: actions/setup-java@v4
        with:
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          java-version: ${{ matrix.java }}
          cache: 'maven'

      - name: Validar Maven Wrapper
        run: |
          chmod +x mvnw
          ./mvnw -v

      - name: Lint (Checkstyle) – opcional
        continue-on-error: true
        if: ${{ hashFiles('**/checkstyle.xml') != '' }}
        run: ./mvnw -B -ntp checkstyle:check

      - name: Lint (PMD) – opcional
        continue-on-error: true
        run: ./mvnw -B -ntp pmd:pmd

      - name: SpotBugs – opcional
        continue-on-error: true
        run: ./mvnw -B -ntp com.github.spotbugs:spotbugs-maven-plugin:check

      - name: Compilar + Testes de Unidade
        run: ./mvnw -B -ntp -DskipITs=true -Djacoco.skip=false verify

      - name: Publicar relatórios
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-reports-java${{ matrix.java }}
          path: |
            **/target/surefire-reports/*
            **/target/jacoco/*.xml
            **/target/site/*
          if-no-files-found: ignore

  integration:
    name: Integração | Kafka + Redis + Resilience
    runs-on: ubuntu-latest
    needs: validate
    services:
      zookeeper:
        image: confluentinc/cp-zookeeper:7.6.1
        env:
          ZOOKEEPER_CLIENT_PORT: 2181
          ZOOKEEPER_TICK_TIME: 2000
        ports:
          - 2181:2181
      kafka:
        image: confluentinc/cp-kafka:7.6.1
        env:
          KAFKA_BROKER_ID: 1
          KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
          KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092
          KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
          KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
          KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
          KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
          KAFKA_AUTO_CREATE_TOPICS_ENABLE: 'true'
        ports:
          - 9092:9092
      redis:
        image: redis:7
        ports:
          - 6379:6379
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configurar Java 17
        uses: actions/setup-java@v4
        with:
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          java-version: '17'
          cache: 'maven'

      - name: Aguardar serviços (Kafka/Redis)
        shell: bash
        run: |
          for host in kafka:9092 redis:6379; do
            echo "Aguardando $host..."
            for i in {1..60}; do
              (echo > /dev/tcp/${host%:*}/${host#*:}) && echo "OK" && break || sleep 2
              if [ "$i" -eq 60 ]; then echo "Timeout em $host"; exit 1; fi
            done
          done

      - name: Testes de Integração (failsafe)
        env:
          KAFKA_BOOTSTRAP_SERVERS: kafka:9092
          REDIS_HOST: redis
        run: ./mvnw -B -ntp -DskipITs=false -Dit.kafka.bootstrap=${KAFKA_BOOTSTRAP_SERVERS} -Dit.redis.host=${REDIS_HOST} verify

      - name: Publicar relatórios de integração
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: it-reports
          path: |
            **/target/failsafe-reports/*
            **/target/surefire-reports/*
          if-no-files-found: ignore

  security:
    name: Segurança | SCA + SBOM
    runs-on: ubuntu-latest
    needs: [validate]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Dependency Review (GitHub)
        uses: actions/dependency-review-action@v4

      - name: Gerar SBOM (Syft)
        uses: anchore/sbom-action@v0
        with:
          format: cyclonedx-json
          output-file: sbom-cdx.json

      - name: Publicar SBOM
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: sbom-cdx.json

  docker:
    name: Docker | Build + Push (GHCR)
    runs-on: ubuntu-latest
    needs: [integration]
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch' && inputs.release == true
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configurar QEMU
        uses: docker/setup-qemu-action@v3

      - name: Configurar Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extrair versão
        id: ver
        run: |
          VERSION=$(git describe --tags --always --dirty)
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Build e Push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ env.DOCKER_IMAGE }}:latest
            ${{ env.DOCKER_IMAGE }}:${{ steps.ver.outputs.version }}
          cache-from: type=registry,ref=${{ env.DOCKER_IMAGE }}:buildcache
          cache-to: type=registry,ref=${{ env.DOCKER_IMAGE }}:buildcache,mode=max

  release:
    name: Release | Artefatos + GitHub Release
    runs-on: ubuntu-latest
    needs: [validate]
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configurar Java 17
        uses: actions/setup-java@v4
        with:
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          java-version: '17'

      - name: Build pacote
        run: ./mvnw -B -ntp -DskipTests package

      - name: Publicar artefatos (JAR)
        uses: actions/upload-artifact@v4
        with:
          name: release-jars
          path: '**/target/*.jar'

      - name: Criar Release
        uses: softprops/action-gh-release@v2
        with:
          files: '**/target/*.jar'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  codeql:
    name: CodeQL | Análise Estática
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read
    strategy:
      fail-fast: false
      matrix:
        language: [ 'java' ]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Inicializar CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}

      - name: Compilar
        run: ./mvnw -B -ntp -DskipTests package

      - name: Analisar
        uses: github/codeql-action/analyze@v3
